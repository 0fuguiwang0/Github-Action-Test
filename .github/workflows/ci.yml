# name: PR Build & Deploy

# # åªåœ¨ä»»ä½• PR æ‰“å¼€/æ›´æ–°æ—¶è§¦å‘
# on:
#   pull_request:

# jobs:
#   # ä¸€ã€Build Jobï¼šæ‹‰ä»£ç â†’npm buildâ†’æ‰“é•œåƒâ†’push Registry
#   build:
#     name: ðŸ”¨ Build & Push Image
#     runs-on: ubuntu-latest
#     outputs:
#       image_tag: ${{ steps.build_image.outputs.image_tag }}  # âœ… æŒ‡å®šè¾“å‡ºæ¥æº
#     steps:
#       - name: Checkout æºç 
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: "18"

#       - name: å®‰è£… & æ‰“åŒ…
#         run: |
#           npm ci
#           npm run build

#       - name: ç™»å½•é•œåƒä»“åº“
#         uses: docker/login-action@v2
#         with:
#           registry: ${{ secrets.DOCKER_REGISTRY }}
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
#         id: build_image  # âœ… å…³é”®ï¼šåŠ ä¸Š id æ‰èƒ½è¢« outputs ä½¿ç”¨
#         run: |
#           TAG_NAME="${{ github.event.pull_request.base.ref }}"
#           SHA_TAG="${{ github.sha }}"
#           IMAGE_BASE="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/my-frontend"
#           IMAGE_SHA="$IMAGE_BASE:$SHA_TAG"
#           IMAGE_TAG="$IMAGE_BASE:$TAG_NAME"

#           echo "Building Docker image: $IMAGE_SHA"
#           docker build -t "$IMAGE_SHA" -t "$IMAGE_TAG" .

#           echo "Pushing images..."
#           docker push "$IMAGE_SHA"
#           docker push "$IMAGE_TAG"

#           echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT  # âœ… æ­£ç¡®ä¼ è¾“å‡ºå£

#   deploy-dev:
#     name: ðŸš€ Deploy to Dev
#     needs: build
#     runs-on: ubuntu-latest
#     # åªæœ‰å½“ PR ç›®æ ‡åˆ†æ”¯æ˜¯ dev æ—¶æ‰è§¦å‘
#     if: ${{ github.event.pull_request.base.ref == 'dev' }}
#     # å…³è” GitHub Environment (è‡ªåŠ¨æ‹‰ dev é‡Œçš„ Secretsã€èµ°å®¡æ‰¹)
#     environment: dev
#     steps:
#       - name: SSH & éƒ¨ç½² Dev
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           key: ${{ secrets.SSH_KEY }}
#           script: |
#             IMAGE=${{ needs.build.outputs.image_tag }}
#             docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ${{ secrets.DOCKER_REGISTRY }}
#             docker pull $IMAGE
#             # å…ˆåœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå®¹å™¨åè‡ªå·±æ”¹ï¼‰
#             docker stop my-frontend || true
#             docker rm my-frontend || true
#             docker run -d --name my-frontend -p 8083:8083 $IMAGE

#   deploy-uat:
#     name: ðŸš€ Deploy to UAT
#     needs: build
#     runs-on: ubuntu-latest
#     if: ${{ github.event.pull_request.base.ref == 'uat' }}
#     environment: uat
#     steps:
#       - name: SSH & éƒ¨ç½² UAT
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           key: ${{ secrets.SSH_KEY }}
#           script: |
#             IMAGE=${{ needs.build.outputs.image_tag }}
#             docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ${{ secrets.DOCKER_REGISTRY }}
#             docker pull $IMAGE
#             docker stop my-frontend || true
#             docker rm my-frontend || true
#             docker run -d --name my-frontend -p 8082:8082 $IMAGE

#   # å››ã€Deploy åˆ° prod
#   deploy-prod:
#     name: ðŸš€ Deploy to Prod
#     needs: build
#     runs-on: ubuntu-latest
#     # å‡è®¾ä¸»åˆ†æ”¯ main ç”¨äºŽ prod
#     if: ${{ github.event.pull_request.base.ref == 'main' }}
#     environment: prod
#     steps:
#       - name: SSH & éƒ¨ç½² Prod
#         uses: appleboy/ssh-action@v0.1.7
#         env:
#           IMAGE: ${{ needs.build.outputs.image_tag }}
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           key: ${{ secrets.SSH_KEY }}
#           script: |
#             echo "Image is: $IMAGE"
#             docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ${{ secrets.DOCKER_REGISTRY }}
#             docker pull $IMAGE
#             docker stop my-frontend || true
#             docker rm my-frontend || true
#             docker run -d --name my-frontend -p 8081:8081 $IMAGE

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build_image.outputs.image_tag }}
    steps:
      - name: Set Image Tag
        id: build_image
        run: |
          echo "image_tag=my-registry.com/myapp:dev" >> $GITHUB_OUTPUT

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Show Output
        run: echo "Image is: ${{ needs.build.outputs.image_tag }}"
